<!DOCTYPE html>
<html>
<head>
  <title>Black Screen</title>
  <link rel="stylesheet" type="text/css" href="styles/main.css" media="screen"/>
</head>
<body>

<div id="board"></div>

<script>
  var $ = require('jquery');
  var pty = require('pty.js');
  var Convert = require('ansi-to-html');
  var _ = require('lodash');
  var convert = new Convert();
  var TerminalEmulator = require('./src/terminal_emulator');

  var terminalEmulator = new TerminalEmulator();

  var buffer = '';

  function run(command) {
    terminalEmulator.execute(command);

    terminalEmulator.on('data', function (data) {
      _.map(data, function (char) {
        if (char.charCodeAt(0) == 27) {
          print('\\E');
        } else {
          print(char);
        }
      });
    });

    terminalEmulator.on('end', createPrompt);
  }

  function createPrompt() {
    currentInput().removeClass('currentInput');
    currentOutput().removeClass('currentOutput');

    var newInput = document.createElement("input");
    newInput.type = "text";
    $(newInput).addClass('currentInput');
    document.getElementById('board').appendChild(newInput);
    newInput.focus();
    addEnterHandler();

    var container = document.createElement("pre");
    container.className += 'currentOutput';

    document.getElementById('board').appendChild(container);
  }

  function addEnterHandler() {
    currentInput().keydown(function (e) {
      if (e.which == 13) {
        run(currentInput().val());

        return false;
      }

      // Ctrl+P
      if ((e.ctrlKey && e.keyCode == 80) || e.keyCode == 38) {
        currentInput().val(terminalEmulator.history.previous());

        return false;
      }
    });
  }

  function print(data) {
    currentOutput()[0].innerHTML += data;
  }

  function currentInput() {
    return $('.currentInput');
  }

  function currentOutput() {
    return $('.currentOutput');
  }

  function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
  }

  createPrompt();
</script>
</body>
</html>

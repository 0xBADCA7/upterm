<!DOCTYPE html>
<html>
<head>
  <title>Black Screen</title>
  <link rel="stylesheet" type="text/css" href="styles/main.css" media="screen"/>
  <script src="https://fb.me/react-0.13.1.js"></script>
  <script src="https://fb.me/JSXTransformer-0.13.1.js"></script>
  <script type="text/jsx">
    var $ = require('jquery');
    var Terminal = require('./compiled/terminal');

    var Board = React.createClass({
      getInitialState: function () {
        return {terminal: new Terminal()};
      },
      componentDidMount: function () {
        this.state.terminal.on('invocation', function () {
          this.forceUpdate();
        }.bind(this));
      },
      render: function () {
        var invocations = this.state.terminal.invocations.map(function (invocation, index) {
          return (
              <Invocation key={index} invocation={invocation}/>
          )
        });
        return (
            <div id="board">
              <div id="invocations">
                {invocations}
              </div>
              <StatusLine/>
            </div>
        );
      }
    });


    var Invocation = React.createClass({
      componentDidMount: function () {
        this.props.invocation.on('data', function () {
          this.forceUpdate();
        }.bind(this));
      },
      render: function () {
        return (
            <div className="invocation">
              <Prompt prompt={this.props.invocation.getPrompt()}/>
              <BSBuffer buffer={this.props.invocation.getBuffer()}/>
            </div>
        );
      }
    });


    var BSBuffer = React.createClass({
      render: function () {
        var rows = this.props.buffer.map(function (row, index) {
          return (
              <BufferRow key={index} row={row}/>
          )
        });
        return (
            <pre className="output">
              {this.props.buffer.toString()}
            </pre>
        )
      }
    });

    var BufferRow = React.createClass({
      render: function () {
        return this.props.row.map(function (wrappedChar) {
          return wrappedChar.toString();
        }).join('');
      }
    });


    var Prompt = React.createClass({
      handleKeyDown: function (event) {
        if (event.keyCode == 13) {
          this.props.prompt.send(this.refs.command.getDOMNode().value);
        }
      },
      render: function () {
        return (
            <input onKeyDown={this.handleKeyDown} type="text" ref="command" autoFocus="autofocus"/>
        )
      }
    });


    var StatusLine = React.createClass({
      render: function () {
        return (
            <div id="status-line">
              <CurrentDirectory/>
            </div>
        )
      }
    });


    var CurrentDirectory = React.createClass({
      render: function () {
        return (
            <div id="current-directory"></div>
        )
      }
    });


    React.render(<Board />, document.getElementById('black-board'));
  </script>
</head>
<body>

<div id="sizes-calculation">
  0123456789
</div>

<div id="black-board"></div>

</body>
</html>

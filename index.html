<!DOCTYPE html>
<html>
<head>
  <title>Black Screen</title>
  <link rel="stylesheet" type="text/css" href="styles/main.css" media="screen" />
</head>
<body>

  <div id="board"></div>

  <script>
  var child_process = require('child_process');
  var $ = require('jquery');
  var pty = require('pty.js');
  var Convert = require('ansi-to-html');
  var _ = require('lodash');
  var convert = new Convert();

  process.stdin.setEncoding('utf8');
  process.stdout.setEncoding('utf8');


  var blackHistory = [];

  // terminal.on('data', print);
  var buffer = '';

  function run(command) {
    var terminal = pty.spawn(process.env.SHELL, ['-c', '-i', 'TERM=black-screen;TERMINFO=/Users/me/.terminfo/62/black-screen;' + command], {
    // var terminal = pty.spawn(process.env.SHELL, ['-c', '-i', command], {
      name: 'black-screen',
      cols: 120,
      rows: 80,
      cwd: process.env.HOME,
      // env: _.extend(process.env, { TERM: 'black-screen' })
      env: { TERM: 'black-screen' }
    });

    terminal.on('data', function(data) {
      var codes = _.map(data, function(char) {
        if (char.charCodeAt(0) == 27) {
          print('\\E');
        } else {
          print(char);
        }
        // return char.charCodeAt(0);
      });
      // print(data);
      // buffer += data;
    });

    terminal.on('end', function(data) {
      // print(buffer);
      // buffer = '';
      createPrompt();
    });
  }

  function createPrompt() {
    currentInput().removeClass('currentInput');
    currentOutput().removeClass('currentOutput');

    var newInput = document.createElement("input");
    newInput.type="text";
    $(newInput).addClass('currentInput');
    document.getElementById('board').appendChild(newInput);
    newInput.focus();
    addEnterHandler();

    var container = document.createElement("pre");
    container.className +='currentOutput';

    document.getElementById('board').appendChild(container);
  }

  function addEnterHandler() {
    currentInput().keydown(function (e) {
      if (e.which == 13) {
        var command = currentInput().val();

        blackHistory.push(command);
        run(command);

        return false;
      }

      // Ctrl+P
      if((e.ctrlKey && e.keyCode == 80) || e.keyCode == 38){
        currentInput().val(blackHistory.pop());

        return false;
      }
    });
  }

  function print(data) {
    // container.innerHTML = convert.toHtml(data);
    currentOutput()[0].innerHTML += data;
  }

  function currentInput() {
    return $('.currentInput');
  }

  function currentOutput() {
    return $('.currentOutput');
  }

  function escapeHtml(unsafe) {
    return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
  }

  createPrompt();
  </script>
</body>
</html>
